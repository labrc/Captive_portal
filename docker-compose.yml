services:
  certs-init:
    image: alpine
    container_name: certs_init
    volumes:
      - ./certs:/certs
    entrypoint: >
      sh -c "
      apk add --no-cache openssl &&
      if [ ! -f /certs/server.key ] || [ ! -f /certs/server.crt ]; then
        echo 'Generando certificados SSL...';
        openssl req -x509 -nodes -days 365 \
          -newkey rsa:2048 \
          -keyout /certs/server.key \
          -out /certs/server.crt \
          -subj '/CN=portal.local';
      else
        echo 'âœ… Certificados ya existen, no se regeneran.';
      fi
      "
    restart: "no"
  db:
    image: postgres:16
    container_name: captive_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: portalPortal
      POSTGRES_PASSWORD: portalPortal123
      POSTGRES_DB: captive_portal
    volumes:
      - ./db_data:/var/lib/postgresql/data:Z
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U portalPortal -d captive_portal"]
      interval: 15s
      timeout: 5s
      retries: 10


  captive_app:
    container_name: captive_app
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    build:
      context: .
    ports:
      - "80:80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/test"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: portalPortal
      DB_PASS: portalPortal123
      DB_NAME: captive_portal
    volumes:
      - ./exports:/app/exports:Z          # para CSV
      - ./config.ini:/app/config.ini:Z    # config real
      - ./logs:/app/logs:Z                # logs del portal
  nginx:
    image: nginx:alpine
    ports:
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs/server.crt:/etc/nginx/certs/server.crt:ro
      - ./certs/server.key:/etc/nginx/certs/server.key:ro
    depends_on:
      - captive_app
      - certs-init